### loding libraries ...
library(rstan); library(splines)

###  Stan model for Penalized B-Spline Based on Chapter 12 of the book of: 
### 		"Alston, C.L., Mengersen, K.L. and Pettitt, A.N. eds., 2012. Case studies in Bayesian statistical modelling and analysis. John Wiley & Sons."
cat(  
	"
	data 
		{
		int<lower=1> n;
		int<lower=1> num_knots;
		int<lower=1> degree;
		vector[n] y;
		matrix[n, num_knots+degree] B;
		matrix[num_knots+degree, num_knots+degree] Q;
		}
		
	parameters 
		{
		vector[num_knots+degree] theta;
		real<lower=0> sigma2;
		}
		
	transformed parameters
		{
		vector[n] mu;
		mu = B * theta;
		}
		
	model 
		{
		sigma2 ~ inv_chi_square(1);
		target += -0.5 * quad_form(Q, theta)/sigma2;
		y ~ normal(mu, sqrt(sigma2));
		}
		
	generated quantities
		{
		vector[n] yhat;
		yhat = B * theta;
		}
	"
	, file="PBSmodel.stan")

### compiling model ...
PBS_Stan_model <- stan_model("PBSmodel.stan")

### data from Page 47 of the this book: "Ruppert, D., Wand, M.P. and Carroll, R.J., 2003. Semiparametric regression (No. 12). Cambridge university press."
range <- c(	390,391,393,394,396,397,399,400,402,403,405,406,408,409,411,412,414,415,417,
			418,420,421,423,424,426,427,429,430,432,433,435,436,438,439,441,442,444,445,
			447,448,450,451,453,454,456,457,459,460,462,463,465,466,468,469,471,472,474,
			475,477,478,480,481,483,484,486,487,489,490,492,493,495,496,498,499,501,502,
			504,505,507,508,510,511,513,514,516,517,519,520,522,523,525,526,528,529,531,
			532,534,535,537,538,540,541,543,544,546,547,549,550,552,553,555,556,558,559,
			561,562,564,565,567,568,570,571,573,574,576,577,579,580,582,583,585,586,588,
			589,591,592,594,595,597,598,600,601,603,604,606,607,609,610,612,613,615,616,
			618,619,621,622,624,625,627,628,630,631,633,634,636,637,639,640,642,643,645,
			646,648,649,651,652,654,655,657,658,660,661,663,664,666,667,669,670,672,673,
			675,676,678,679,681,682,684,685,687,688,690,691,693,694,696,697,699,700,702,
			703,705,706,708,709,711,712,714,715,717,718,720)
		
logratio <- c(	-0.05035573,-0.06009706,-0.04190091,-0.0509847,-0.05991345,-0.02842392,-0.05958421,-0.03988881,
			-0.02939582,-0.03949445,-0.04764749,-0.06038,-0.03123034,-0.03816584,-0.07562269,-0.05001751,
			-0.0457295,-0.07766966,-0.02460641,-0.07133184,-0.01320746,-0.03162615,-0.03247478,-0.08840797,
			-0.07024166,-0.02877263,-0.03696702,-0.1015625,-0.06831373,-0.03175751,-0.05336819,-0.05726381,
			-0.02295515,-0.01479166,-0.02531884,-0.09538944,-0.08126108,-0.06473801,-0.04940004,-0.02453983,
			-0.004223316,-0.04692908,-0.0726426,-0.06375497,-0.04867571,-0.07902194,-0.05508392,-0.03600915,
			-0.00819836,-0.02991638,-0.05904417,-0.04349076,-0.1083667,-0.07164495,-0.1080431,-0.01144756,
			-0.09066497,-0.07438849,-0.08880716,-0.0724013,-0.03941208,-0.08413698,-0.04477778,-0.1486651,
			-0.08027266,-0.05482479,-0.01202489,0.0193486,-0.08389427,-0.04157477,-0.06109121,-0.06044325,
			-0.08220186,-0.07530349,-0.04480991,0.008222156,-0.06758809,-0.03249946,-0.02198146,-0.04232621,
			-0.07785213,-0.07806195,0.02690717,-0.09226096,-0.09159045,-0.004001756,-0.01818933,-0.02527617,
			-0.05842499,-0.05257305,-0.02606248,-0.1180877,-0.0526311,-0.04135148,-0.009199134,-0.08336644,
			-0.01253334,-0.06290332,-0.06018018,-0.1035686,-0.1261166,-0.03887012,-0.05654984,-0.07444842,
			-0.003788664,-0.09203971,-0.05517356,-0.1004337,-0.169438,-0.06414184,-0.1867348,-0.09086006,
			-0.05918714,-0.0810351,-0.1034776,-0.06567394,-0.1821245,-0.0857127,-0.1216041,-0.1342692,-0.1933908,
			-0.1178639,-0.287109,-0.2739447,-0.1867194,-0.1891953,-0.2948625,-0.3711984,-0.2326753,-0.2719736,
			-0.2750204,-0.3105271,-0.3991572,-0.4256722,-0.5190272,-0.4245844,-0.3982711,-0.3463767,-0.4404651,
			-0.4169474,-0.3663678,-0.4121902,-0.5258849,-0.4581079,-0.4604081,-0.5218792,-0.5664269,-0.7089956,
			-0.6505402,-0.5719829,-0.4014736,-0.5251362,-0.5635558,-0.5900392,-0.4241413,-0.4893619,-0.5423047,
			-0.6555049,-0.509341,-0.4830832,-0.6007552,-0.6836965,-0.5153322,-0.4857863,-0.6638135,-0.7692632,
			-0.4796891,-0.7720272,-0.5406614,-0.5651009,-0.4565217,-0.4199023,-0.5397169,-0.9238232,-0.640224,
			-0.8252677,-0.5966183,-0.5465871,-0.4236746,-0.7076495,-0.4554013,-0.6759382,-0.6588688,-0.7198635,
			-0.5682055,-0.6394204,-0.7310237,-0.6116481,-0.6172596,-0.7559637,-0.7663848,-0.7123093,-0.7086443,
			-0.5377112,-0.72429,-0.6214564,-0.6324121,-0.9495535,-0.6757631,-0.5887097,-0.9114353,-0.4326794,
			-0.8590017,-0.7987653,-0.6931472,-0.886574,-0.7968261,-0.5025268,-0.4716702,-0.7801088,-0.6668431,
			-0.5783479,-0.7874522,-0.6156956,-0.8967602,-0.7077379,-0.672567,-0.6218413,-0.8657611,-0.557754,-0.8026684)

plot(range, logratio)

### preparing data to send Stan
num_knots = 20
degree = 3

# Basis B-Spline and D & Q matrix (do not change)
bspline <- function(x, x1=min(x), xr=max(x), num_knots=20, bdeg=1)
	{
	dx <- (xr-x1) /num_knots
	knots<- seq(x1- bdeg * dx, xr +bdeg* dx, by = dx)
	B <- spline.des(knots, x, bdeg + 1,0 * x) $design
	B
	}
	
n=length(range)
B <- bspline(range,min(range)-.1*sd(range),max(range)+.1*sd(range),num_knots=num_knots,bdeg=degree)
D <- diag(ncol(B))
for (k in 1:degree) D <- diff(D)
Q = t(D)%*%D

data = list(n=n, num_knots=num_knots, degree=degree, y=logratio, B=B, Q=Q)

#### sampling ...
fit <- sampling(PBS_Stan_model, data=data, pars=c("theta","sigma2","yhat"), chains=5, iter=5000) 

### getting means
M = summary(fit)$summary
yhat = ylow = yup = 0
for(i in 1:n)
	{
	yhat[i] = M[paste0("yhat[",i,"]"),"mean"]
	ylow[i] = max(M[paste0("yhat[",i,"]"),"2.5%"])
	yup[i] = max(M[paste0("yhat[",i,"]"),"97.5%"])
	}
	
### drawing results	
m1 = min(logratio, yhat, ylow, yup)
m2 = max(logratio, yhat, ylow, yup)
plot(range, logratio, ylim=c(m1,m2))
	lines(range, yhat, lwd=3, lty = 1, col="#5B9BD5")
	lines(range, ylow, lwd=1, lty = 2, col="#5B9BD5")
	lines(range, yup, lwd=1, lty = 2, col="#5B9BD5")



